<?php

// Class: TasksManager_PDO.class.php
// Table: ts_tasks
// Generated by createEntity.php, written by Paulo Ferreira (paulo.ferreira@arkium.eu)
// Date : Sat, 01 Feb 2014 17:21:48 +0000
namespace Library\Models;

class TasksManager_PDO extends TasksManager {

	private function getData(\Library\HTTPRequest $request) {
		return new \Library\Entities\Tasks(array(
				'task_id' => (int) $request->postData('task_id'),
				'code' => (string) $request->postData('code'),
				'name' => (string) $request->postData('name'),
				'invoicing_entity_id' => (int) $request->postData('invoicing_entity_id'),
				'customer_id' => (int) $request->postData('customer_id'),
				'task_type_id' => (int) $request->postData('task_type_id'),
				'closing_date' => (string) $request->postData('closing_date'),
				'intermediate_id' => (int) $request->postData('intermediate_id'),
				'num_proj' => (int) $request->postData('num_proj'),
				'milestone_type_id' => (int) $request->postData('milestone_type_id'),
				'start_date' => (string) $request->postData('start_date'),
				'end_date' => (string) $request->postData('end_date'),
				'project_proposal' => (int) $request->postData('project_proposal'),
				'note' => (string) $request->postData('note'),
				'status' => (int) $request->postData('status'),
				'update_time' => (string) $request->postData('update_time'),
				'created_time' => (string) $request->postData('created_time') 
		));
	}

	public function getDatabases(\Library\HTTPRequest $request, \Library\Datatable $ini) {
		$table = new \Library\Datatables($request, $ini);
		return $table->run();
	}

	public function getList($debut = -1, $limite = -1) {
		$query = "SELECT * FROM ts_tasks";
		if ($debut != -1 || $limite != -1) {
			$query .= ' LIMIT ' . (int) $limite . ' OFFSET ' . (int) $debut;
		}
		try {
			$result = parent::$dao->query($query);
			$output = $result->fetchAll();
			$result->closeCursor();
		} catch (\PDOException $e) {
			$output['reponse'] = 'The database is not able to be read!<br/>';
			$output['reponse'] .= "Code Error: " . $e->getCode() . "<br/>";
			$output['reponse'] .= "Syntax Error: " . $e->getMessage();
		}
		return $output;
	}

	public function getUnique($id) {
		$query = "SELECT 
			task_id,
			code,
			name,
			invoicing_entity_id,
			customer_id,
			task_type_id,
			closing_date,
			intermediate_id,
			num_proj,
			milestone_type_id,
			start_date,
			end_date,
			project_proposal,
			note,
			status,
			update_time,
			created_time
		FROM ts_tasks
		WHERE task_id = :id";
		try {
			$result = parent::$dao->prepare($query);
			$result->bindValue(':id', (int) $id, \PDO::PARAM_INT);
			$result->execute();
			// $result->setFetchMode(\PDO::FETCH_CLASS | \PDO::FETCH_PROPS_LATE, '\Library\Entities\Tasks');
			$output = (array) $result->fetch(\PDO::FETCH_NUM);
			
			$output['reponse'] = true;
		} catch (\PDOException $e) {
			$output['reponse'] = 'The database is not able to be read!<br/>';
			$output['reponse'] .= "Code Error: " . $e->getCode() . "<br/>";
			$output['reponse'] .= "Syntax Error: " . $e->getMessage();
		}
		return $output;
	}

	public function count() {
		$query = "SELECT COUNT(*) FROM ts_tasks";
		return parent::$dao->query($query)->fetchColumn();
	}

	public function add(\Library\HTTPRequest $request) {
		$tasks = $this->getData($request);
		$query = "INSERT INTO ts_tasks SET 
			code = :code,
			name = :name,
			invoicing_entity_id = :invoicing_entity_id,
			customer_id = :customer_id,
			task_type_id = :task_type_id,
			closing_date = :closing_date,
			intermediate_id = :intermediate_id,
			num_proj = :num_proj,
			milestone_type_id = :milestone_type_id,
			start_date = :start_date,
			end_date = :end_date,
			project_proposal = :project_proposal,
			note = :note,
			status = :status,
			created_time = NOW()";
		try {
			parent::$dao->beginTransaction();
			$result = parent::$dao->prepare($query);
			
			$result->bindValue(':code', $tasks->code());
			$result->bindValue(':name', $tasks->name());
			$result->bindValue(':invoicing_entity_id', $tasks->invoicing_entity_id());
			$result->bindValue(':customer_id', $tasks->customer_id());
			$result->bindValue(':task_type_id', $tasks->task_type_id());
			$result->bindValue(':closing_date', $tasks->closing_date());
			$result->bindValue(':intermediate_id', $tasks->intermediate_id());
			$result->bindValue(':num_proj', $tasks->num_proj());
			$result->bindValue(':milestone_type_id', $tasks->milestone_type_id());
			$result->bindValue(':start_date', $tasks->start_date());
			$result->bindValue(':end_date', $tasks->end_date());
			$result->bindValue(':project_proposal', $tasks->project_proposal());
			$result->bindValue(':note', $tasks->note());
			$result->bindValue(':status', $tasks->status());
			
			$output['reponse'] = $result->execute();
			$this->lastInsertId = parent::$dao->lastInsertId();
			parent::$dao->commit();
		} catch (\PDOException $e) {
			parent::$dao->rollback();
			$error = $result->errorInfo();
			if ($error[1] == '1062') {
				$output['reponse'] = 'This code already exists in the database.';
			} else {
				$output['reponse'] = 'The update of the database is not successful!<br/>';
				$output['reponse'] .= "Code Error: " . $e->getCode() . "<br/>";
				$output['reponse'] .= "Syntax Error: " . $e->getMessage();
			}
		}
		return $output;
	}

	public function modify(\Library\HTTPRequest $request) {
		$tasks = $this->getData($request);
		$query = "UPDATE ts_tasks SET 
			code = :code,
			name = :name,
			invoicing_entity_id = :invoicing_entity_id,
			customer_id = :customer_id,
			task_type_id = :task_type_id,
			closing_date = :closing_date,
			intermediate_id = :intermediate_id,
			num_proj = :num_proj,
			milestone_type_id = :milestone_type_id,
			start_date = :start_date,
			end_date = :end_date,
			project_proposal = :project_proposal,
			note = :note,
			status = :status
		WHERE task_id = :id";
		try {
			parent::$dao->beginTransaction();
			$result = parent::$dao->prepare($query);
			
			$result->bindValue(':id', $tasks->id(), \PDO::PARAM_INT);
			$result->bindValue(':code', $tasks->code());
			$result->bindValue(':name', $tasks->name());
			$result->bindValue(':invoicing_entity_id', $tasks->invoicing_entity_id());
			$result->bindValue(':customer_id', $tasks->customer_id());
			$result->bindValue(':task_type_id', $tasks->task_type_id());
			$result->bindValue(':closing_date', $tasks->closing_date());
			$result->bindValue(':intermediate_id', $tasks->intermediate_id());
			$result->bindValue(':num_proj', $tasks->num_proj());
			$result->bindValue(':milestone_type_id', $tasks->milestone_type_id());
			$result->bindValue(':start_date', $tasks->start_date());
			$result->bindValue(':end_date', $tasks->end_date());
			$result->bindValue(':project_proposal', $tasks->project_proposal());
			$result->bindValue(':note', $tasks->note());
			$result->bindValue(':status', $tasks->status());
			
			$output['reponse'] = $result->execute();
			parent::$dao->commit();
		} catch (\PDOException $e) {
			parent::$dao->rollback();
			$error = $result->errorInfo();
			if ($error[1] == '1062') {
				$output['reponse'] = 'This code already exists in the database.';
			} else {
				$output['reponse'] = 'The update of the database is not successful!<br/>';
				$output['reponse'] .= "Code Error: " . $e->getCode() . "<br/>";
				$output['reponse'] .= "Syntax Error: " . $e->getMessage();
			}
		}
		return $output;
	}

	public function delete($id) {
		$query = "DELETE FROM ts_tasks WHERE task_id = " . (int) $id;
		try {
			parent::$dao->beginTransaction();
			$result = parent::$dao->prepare($query);
			$output['reponse'] = $result->execute();
			parent::$dao->commit();
		} catch (\PDOException $e) {
			parent::$dao->rollback();
			$output['reponse'] = 'The update of the database is not successful!<br/>';
			$output['reponse'] .= "Code Error: " . $e->getCode() . "<br/>";
			$output['reponse'] .= "Syntax Error: " . $e->getMessage();
		}
		return $output;
	}
}